<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<title>Netxtv</title>

<style>
/* ================= GLOBAL ================= */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
}

html, body {
  min-height: 100%;
  width: 100%;
  overflow-x: hidden;
}

body {
  background: #000000;
  color: #fff;
  padding: 15px;
  -webkit-tap-highlight-color: transparent;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  width: 100%;
  padding: 0 10px;
}

/* ================= LOADING ================= */
.loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  background: #000000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: opacity 0.5s, visibility 0.5s;
  padding: 20px;
  text-align: center;
}

.loading-screen.hide {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

.spinner {
  width: 60px;
  height: 60px;
  border: 5px solid rgba(255, 255, 255, 0.25);
  border-top: 5px solid #fff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}

.loading-text {
  margin-top: 20px;
  font-weight: 600;
  font-size: clamp(14px, 3vw, 16px);
  color: #fff;
  text-align: center;
  max-width: 300px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ================= HEADER ================= */
.league-title {
  text-align: center;
  font-size: clamp(1.2rem, 4vw, 1.6rem);
  margin: 10px 0 20px;
  line-height: 1.3;
  padding: 0 10px;
  word-break: break-word;
  color: #ffcc00;
}

/* ================= SEARCH & FILTER ================= */
.search-box {
  text-align: center;
  margin-bottom: 15px;
  padding: 0 10px;
}

.search-box input {
  width: 100%;
  max-width: 500px;
  padding: 12px 20px;
  border-radius: 30px;
  border: 2px solid #333;
  font-size: 16px;
  background: #222;
  color: #fff;
  transition: all 0.3s;
}

.search-box input:focus {
  outline: none;
  border-color: #ff9800;
  box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.3);
}

.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-bottom: 20px;
  padding: 0 10px;
}

.filters button {
  padding: 10px 20px;
  border: 2px solid #333;
  border-radius: 25px;
  background: #222;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
  flex: 1;
  min-width: 100px;
  max-width: 150px;
}

.filters button:hover {
  background: #333;
  border-color: #ff9800;
}

.filters button.active {
  background: linear-gradient(135deg, #ff5722, #ff9800);
  border-color: #ff5722;
  box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
}

/* ================= MATCH CARD ================= */
.match-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(min(100%, 350px), 1fr));
  gap: 15px;
  padding: 0 5px;
}

@media (max-width: 768px) {
  .match-container {
    grid-template-columns: 1fr;
    gap: 12px;
  }
}

.match-card {
  background: #111;
  border-radius: 15px;
  padding: 20px;
  border: 1px solid #333;
  transition: transform 0.3s, box-shadow 0.3s;
  position: relative;
  overflow: hidden;
}

.match-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(255, 152, 0, 0.2);
  border-color: #ff9800;
}

/* League name */
.league-name {
  text-align: center;
  font-size: clamp(12px, 3vw, 14px);
  color: #ffcc00;
  font-weight: 600;
  margin-bottom: 10px;
  padding: 5px 10px;
  background: #222;
  border-radius: 20px;
  text-transform: uppercase;
}

.match-time {
  text-align: center;
  color: #ffcc00;
  font-weight: bold;
  font-size: clamp(14px, 3vw, 16px);
  margin-bottom: 15px;
  padding: 5px;
  background: #222;
  border-radius: 20px;
}

/* LIVE BAR */
.live-bar {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-weight: bold;
  color: #00ff6a;
  margin-bottom: 10px;
  animation: pulse 1.2s infinite;
  font-size: clamp(14px, 3vw, 16px);
}

.live-dot {
  width: 12px;
  height: 12px;
  background: #00ff6a;
  border-radius: 50%;
  box-shadow: 0 0 10px #00ff6a;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

.team-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 15px 0;
  gap: 10px;
}

.team {
  text-align: center;
  width: 45%;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.team img {
  width: 60px;
  height: 60px;
  min-width: 50px;
  min-height: 50px;
  background: #222;
  border-radius: 50%;
  padding: 6px;
  object-fit: contain;
  transition: transform 0.3s;
  border: 2px solid #333;
}

.team img:hover {
  transform: scale(1.1);
  border-color: #ff9800;
}

.team div {
  font-size: clamp(12px, 2.5vw, 14px);
  font-weight: 600;
  line-height: 1.3;
  word-break: break-word;
  overflow-wrap: break-word;
  max-width: 100%;
  color: #fff;
}

@media (max-width: 480px) {
  .team img {
    width: 50px;
    height: 50px;
  }
  
  .team div {
    font-size: 12px;
  }
}

.vs {
  font-weight: bold;
  color: #ffcc00;
  font-size: clamp(16px, 4vw, 20px);
  margin: 0 5px;
}

.score {
  text-align: center;
  color: #ffcc00;
  font-size: clamp(1.6rem, 6vw, 2rem);
  font-weight: bold;
  margin: 15px 0;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.stream-links {
  text-align: center;
  margin-top: 20px;
}

.stream-link {
  display: inline-block;
  background: linear-gradient(to right, #ff5722, #ff9800);
  padding: 14px 32px;
  border-radius: 30px;
  color: #fff;
  text-decoration: none;
  font-weight: bold;
  font-size: clamp(14px, 3vw, 16px);
  transition: all 0.3s;
  border: none;
  cursor: pointer;
  width: 100%;
  max-width: 250px;
  box-shadow: 0 4px 15px rgba(255, 87, 34, 0.3);
}

.stream-link:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(255, 87, 34, 0.4);
  background: linear-gradient(to right, #ff9800, #ff5722);
}

/* UTILITY CLASSES */
.loading, .error, .no-matches {
  text-align: center;
  padding: 40px 20px;
  font-size: clamp(16px, 4vw, 18px);
  grid-column: 1 / -1;
  color: #fff;
}

.hidden {
  display: none !important;
}

/* FOOTER */
footer {
  text-align: center;
  margin-top: 40px;
  padding: 20px;
  opacity: 0.8;
  font-size: clamp(12px, 2.5vw, 14px);
  border-top: 1px solid #333;
  color: #aaa;
}
</style>
<script type='text/javascript' src='//zoologicalmanufacture.com/3b/87/bb/3b87bb180475e87b0df9e00113d4d7c2.js'></script>

</head>

<body>

<!-- LOADING -->
<div id="loadingScreen" class="loading-screen">
  <div class="spinner"></div>
  <div class="loading-text">Sabar... lagi loading ‚öΩüèÄ</div>
</div>

<div class="container">
  <h2 id="league-title" class="league-title"></h2>

  <div id="searchBox" class="search-box">
    <input id="search" type="text" placeholder="Cari tim atau liga..." autocomplete="off">
  </div>

  <div id="filterBox" class="filters">
    <button data-type="all" class="active">ALL</button>
    <button data-type="1">FOOTBALL</button>
    <button data-type="2">NBA</button>
  </div>

  <div id="matches" class="match-container"></div>
</div>

<footer id="footer"></footer>

<script>
let CFG, allMatches = [], activeFilter = 'all';
// Counter terpisah untuk NBA dan Football
let nbaCounter = 1;
let footballCounter = 1;

/* ===== CONFIG ===== */
async function loadConfig() {
  try {
    const response = await fetch('https://pisionx.pages.dev/api/tigoals.js');
    CFG = await response.json();
    
    console.log('Config loaded successfully:', CFG);
    
  } catch (error) {
    console.error('Failed to load config:', error);
    // Fallback config berdasarkan struktur JSON
    CFG = {
      logoUrlMapping: {
        soccerSource: "http://zq.win007.com/Image/team/images/",
        soccerCdn: "https://cfcdn.xdapiym5297.com/zqwin007/Image/team/images/",
        nbaSource: "http://nba.titan007.com",
        nbaCdn: "https://cfcdn.djimf3u4en.cfd/nbawin007",
        fallback: "https://via.placeholder.com/60?text=No+Logo"
      },
      branding: {
        siteTitle: 'Netxtv',
        footerText: '¬© 2026 Netxtv'
      }
    };
  }
}

/* ===== UTIL ===== */
const qs = n => new URLSearchParams(location.search).get(n);
const hasParam = () => location.search.length > 1;

/* ===== GENERATE PROXY URL ===== */
function getProxyUrl() {
  // Coba gunakan proxy dari config, jika ada
  if (CFG.proxyDomains) {
    const maxRange = CFG.proxyDomains.maxRange || 55;
    const skip = CFG.proxyDomains.skip || [10];
    let randomNum;
    
    do {
      randomNum = Math.floor(Math.random() * maxRange) + 1;
    } while (skip.includes(randomNum));
    
    return `${CFG.proxyDomains.prefix || 'https://tg.selina'}${randomNum}${CFG.proxyDomains.suffix || '.workers.dev'}`;
  }
  
  // Default proxy
  return 'https://tg.selina36.workers.dev';
}

/* ===== FORMAT WAKTU ===== */
function formatWaktu(timestamp) {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  return date.toLocaleDateString('id-ID', {
    year: 'numeric', 
    month: 'numeric', 
    day: 'numeric',
    hour: '2-digit', 
    minute: '2-digit', 
    timeZone: 'Asia/Jakarta'
  });
}

/* ===== HITUNG MENIT PERTANDINGAN ===== */
function hitungMenitPertandingan(startTime_t, state) {
  if (!startTime_t) return 0;
  const tStart = new Date(startTime_t).getTime();
  const now = Date.now();
  let menit = Math.floor((now - tStart) / (1000 * 60));
  
  // Adjust berdasarkan state
  if (state === 3) menit += 45;      // Second half
  else if (state === 4) menit += 90; // Full time
  
  return Math.max(menit, 0);
}

/* ===== GENERATE STREAM LINK DENGAN PARAMETER GO DAN COUNTER TERPISAH ===== */
function generateStreamLink(match) {
  const goParam = qs('go'); // Ambil parameter ?go= dari URL
  
  let streamLink = '';
  
  // Jika ada parameter ?go=, gunakan itu dengan counter global
  if (goParam) {
    // Untuk parameter ?go= kita gunakan counter berdasarkan matchType
    if (match.matchType === 2) { // NBA dengan ?go=
      streamLink = `go:${goParam}${nbaCounter}`;
      nbaCounter++;
    } else { // Football dengan ?go=
      streamLink = `go:${goParam}${footballCounter}`;
      footballCounter++;
    }
  } 
  // Jika tidak ada parameter ?go=, gunakan logika default dengan counter terpisah
  else if (match.matchType === 2) { // NBA tanpa parameter
    streamLink = `go:nba${nbaCounter}`;
    nbaCounter++;
  } else if (match.leagueId === 42) { // Proliga
    streamLink = 'go:proliga';
  } else { // Football (soccer) tanpa parameter
    streamLink = `go:s808${footballCounter}`;
    footballCounter++;
  }
  
  return streamLink;
}

/* ===== LOGO ===== */
function logoUrl(url) {
  if (!url) return CFG.logoUrlMapping?.fallback || 'https://via.placeholder.com/60?text=No+Logo';

  // Handle soccer logos (football)
  if (url.includes('zq.win007.com') || url.includes('Image/team/images/')) {
    const soccerSource = CFG.logoUrlMapping?.soccerSource || 'http://zq.win007.com/Image/team/images/';
    const soccerCdn = CFG.logoUrlMapping?.soccerCdn || 'https://cfcdn.xdapiym5297.com/zqwin007/Image/team/images/';
    
    if (url.startsWith(soccerSource)) {
      const path = url.replace(soccerSource, '');
      return `${getProxyUrl()}/${soccerCdn}${path}`;
    }
    
    // Jika URL sudah dalam format proxy, gunakan langsung
    if (url.includes('workers.dev')) {
      return url;
    }
    
    // Default: gunakan proxy
    return `${getProxyUrl()}/${url}`;
  }

  // Handle NBA logos
  if (url.includes('nba.titan007.com') || url.includes('titan007')) {
    const nbaSource = CFG.logoUrlMapping?.nbaSource || 'http://nba.titan007.com';
    const nbaCdn = CFG.logoUrlMapping?.nbaCdn || 'https://cfcdn.djimf3u4en.cfd/nbawin007';
    
    if (url.startsWith(nbaSource)) {
      let path = url.replace(nbaSource, '');
      // Konversi .png ke .jpg untuk NBA logos
      path = path.replace(/\.png$/i, '.jpg');
      return `${getProxyUrl()}/${nbaCdn}${path}`;
    }
    
    // Jika URL sudah dalam format proxy, gunakan langsung
    if (url.includes('workers.dev')) {
      return url.replace(/\.png$/i, '.jpg');
    }
    
    // Default: gunakan proxy dan konversi ke .jpg
    return `${getProxyUrl()}/${url.replace(/\.png$/i, '.jpg')}`;
  }

  // Untuk URL lainnya, coba gunakan proxy
  if (url.startsWith('http')) {
    return `${getProxyUrl()}/${url}`;
  }

  // Return fallback jika tidak bisa diproses
  return CFG.logoUrlMapping?.fallback || 'https://via.placeholder.com/60?text=No+Logo';
}

/* ===== RENDER ===== */
function render() {
  const box = document.getElementById('matches');
  const searchInput = document.getElementById('search');
  const q = searchInput ? searchInput.value.toLowerCase() : '';
  box.innerHTML = '';
  
  // Reset counter terpisah
  nbaCounter = 1;
  footballCounter = 1;

  let list = [...allMatches];

  if (!hasParam()) {
    if (activeFilter !== 'all') {
      list = list.filter(m => m.matchType == activeFilter);
    }
    if (q) {
      list = list.filter(m =>
        (m.homeName || '').toLowerCase().includes(q) ||
        (m.awayName || '').toLowerCase().includes(q) ||
        (m.leagueEn || '').toLowerCase().includes(q)
      );
    }
  }

  if (!list.length) {
    box.innerHTML = `<div class="no-matches">Tidak ada pertandingan yang sesuai</div>`;
    return;
  }

  // Tentukan apakah ada parameter URL
  const hasURLParam = hasParam();

  list.forEach(match => {
    const card = document.createElement('div');
    card.className = 'match-card';
    
    // League name - hanya tampilkan jika tidak ada parameter URL
    const leagueNameHTML = hasURLParam ? '' : 
      `<div class="league-name">${match.leagueEn || ''}</div>`;
    
    // Time info based on state
    let waktuPertandingan = '';
    let skorInfo = '';
    let liveIndicator = '';
    
    // State mapping:
    // -1: Finished (FT)
    // 0: Not started
    // 1: First half
    // 2: Half time (HT)
    // 3: Second half
    // 4: Finished (FT)
    
    if (match.state === -1 || match.state === 4) {
      // Finished
      waktuPertandingan = `<div class="match-time">FT</div>`;
      skorInfo = `<div class="score">${match.homeScore || 0} - ${match.awayScore || 0}</div>`;
      
    } else if (match.state === 0) {
      // Not started
      waktuPertandingan = `<div class="match-time">${formatWaktu(match.matchTime_t)}</div>`;
      
    } else if (match.state === 1 || match.state === 2 || match.state === 3) {
      // Live match
      liveIndicator = `<div class="live-bar"><div class="live-dot"></div>LIVE</div>`;
      
      const menitBerjalan = hitungMenitPertandingan(match.startTime_t, match.state);
      if (match.state === 2) {
        waktuPertandingan = `<div class="match-time">HT</div>`;
      } else {
        waktuPertandingan = `<div class="match-time">‚è± ${menitBerjalan}'</div>`;
      }
      
      skorInfo = `<div class="score">${match.homeScore || 0} - ${match.awayScore || 0}</div>`;
    }
    
    // Get logo URLs
    const homeLogo = logoUrl(match.homeLogoUrl);
    const awayLogo = logoUrl(match.awayLogoUrl);
    
    // Generate stream link dengan counter terpisah
    const streamLink = generateStreamLink(match);
    
    // Build card HTML - SELALU TAMPILKAN TOMBOL WATCH NOW
    card.innerHTML = `
      ${liveIndicator}
      ${leagueNameHTML}
      ${waktuPertandingan}
      <div class="team-info">
        <div class="team">
          <img src="${homeLogo}" alt="${match.homeName || 'Home'}" 
               loading="lazy" 
               onerror="this.onerror=null; this.src='${CFG.logoUrlMapping?.fallback || 'https://via.placeholder.com/60?text=No+Logo'}'">
          <div>${match.homeName || 'Home'}</div>
        </div>
        <div class="vs">VS</div>
        <div class="team">
          <img src="${awayLogo}" alt="${match.awayName || 'Away'}" 
               loading="lazy"
               onerror="this.onerror=null; this.src='${CFG.logoUrlMapping?.fallback || 'https://via.placeholder.com/60?text=No+Logo'}'">
          <div>${match.awayName || 'Away'}</div>
        </div>
      </div>
      ${skorInfo}
      <div class="stream-links">
        <a href="${streamLink}" class="stream-link" target="_blank">WATCH NOW üì∫</a>
      </div>
    `;
    
    box.appendChild(card);
  });
}

/* ===== INIT ===== */
(async () => {
  try {
    await loadConfig();

    document.title = CFG.branding?.siteTitle || 'Netxtv';
    document.getElementById('footer').textContent = CFG.branding?.footerText || '¬© 2026 Netxtv';

    let list = [];
    try {
      const apiUrl = CFG.apiUrls?.matchSchedule || 'https://dapiab.djimf3u4en.cfd/api/merge/schedules?lang=4';
      console.log('Fetching matches from:', apiUrl);
      const response = await fetch(apiUrl);
      const data = await response.json();
      list = data.matchList || [];
      console.log(`Loaded ${list.length} matches`);
    } catch (error) {
      console.error('Failed to load matches:', error);
      const matchesContainer = document.getElementById('matches');
      matchesContainer.innerHTML = `<div class="error">Gagal memuat data pertandingan. Silakan refresh halaman.</div>`;
    }

    const id = qs('id'), type = qs('type');
    if (id) {
      list = list.filter(x => x.leagueId == id);
      const leagueTitle = document.getElementById('league-title');
      if (leagueTitle && list[0]?.leagueEn) {
        leagueTitle.textContent = list[0].leagueEn;
      }
    }
    if (type) {
      list = list.filter(x => x.matchType == type);
    }

    allMatches = list;

    if (hasParam()) {
      const searchBox = document.getElementById('searchBox');
      const filterBox = document.getElementById('filterBox');
      if (searchBox) searchBox.classList.add('hidden');
      if (filterBox) filterBox.classList.add('hidden');
    }

    render();

    const searchInput = document.getElementById('search');
    if (searchInput) {
      let searchTimeout;
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(render, 300);
      });
    }

    document.querySelectorAll('.filters button').forEach(b => {
      b.addEventListener('click', () => {
        document.querySelectorAll('.filters button').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        activeFilter = b.dataset.type;
        render();
      });
    });

    // Hide loading screen
    setTimeout(() => {
      const loadingScreen = document.getElementById('loadingScreen');
      if (loadingScreen) {
        loadingScreen.classList.add('hide');
        setTimeout(() => {
          loadingScreen.style.display = 'none';
        }, 500);
      }
    }, 800);

    // Auto update every 30 seconds
    setInterval(render, 30000);

    // Handle orientation change
    window.addEventListener('orientationchange', () => {
      setTimeout(render, 100);
    });

    // Handle resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(render, 250);
    });

  } catch (error) {
    console.error('Initialization error:', error);
    const loadingScreen = document.getElementById('loadingScreen');
    if (loadingScreen) {
      loadingScreen.innerHTML = `
        <div style="text-align: center; padding: 20px; max-width: 300px;">
          <div style="color: #ff6b6b; margin-bottom: 20px; font-size: 16px;">‚ö†Ô∏è Gagal memuat data</div>
          <button onclick="location.reload()" style="
            background: linear-gradient(to right, #ff5722, #ff9800);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            max-width: 200px;
          ">Coba Lagi</button>
        </div>
      `;
    }
  }
})();
</script>

</body>
</html>
