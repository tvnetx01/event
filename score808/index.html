<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Netxtv</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,Tahoma}
body{
  background:linear-gradient(135deg,#1a2a6c,#b21f1f,#fdbb2d);
  color:#fff;min-height:100vh;padding:20px
}
.container{max-width:1000px;margin:auto}
.league-title{text-align:center;font-size:1.6rem;margin:20px 0}
.search-box{
  text-align:center;margin-bottom:15px
}
.search-box input{
  width:80%;max-width:400px;
  padding:8px;border-radius:20px;border:none
}
.match-container{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(350px,1fr));
  gap:12px
}
.match-card{
  background:rgba(255,255,255,.12);
  border-radius:10px;
  padding:18px
}
.match-time{text-align:center;color:#ffcc00;font-weight:bold;margin:8px 0}
.team-info{display:flex;justify-content:space-between;align-items:center}
.team{width:40%;text-align:center}
.team img{
  width:60px;height:60px;
  background:#fff;border-radius:50%;padding:5px
}
.vs{font-weight:bold;color:#ffcc00}
.score{text-align:center;font-size:1.4rem;color:#ffcc00;margin:6px 0}
.stream-links{text-align:center;margin-top:10px}
.stream-link{
  background:linear-gradient(to right,#ff5722,#ff9800);
  padding:8px 18px;border-radius:25px;
  color:#fff;text-decoration:none;font-weight:bold
}
.match-status{text-align:center;font-weight:bold}
.match-status.live{color:#ff5722}
.loading,.error,.no-matches{text-align:center;padding:30px}
@media(max-width:768px){.match-container{grid-template-columns:1fr}}
</style>
</head>

<body>
<div class="container">
  <h2 id="league-title" class="league-title"></h2>

  <div id="searchBox" class="search-box" style="display:none">
    <input id="searchInput" placeholder="Cari nama club / liga...">
  </div>

  <div id="matches" class="match-container"></div>
</div>

<footer id="footer" style="text-align:center;margin-top:30px;opacity:.8"></footer>

<script>
let CFG, currentWorker;

/* ========== LOAD CONFIG ========== */
async function loadConfig(){
  const r = await fetch('https://pisionx.pages.dev/api/tigoals.js');
  CFG = await r.json();
}

/* ========== WORKER & LOGO ========== */
function getRandomWorker(tried=[]){
  const max = CFG.proxyDomains.maxRange;
  const skip = CFG.proxyDomains.skip || [];
  let w;
  do{
    w = Math.floor(Math.random()*max)+1;
  }while(skip.includes(w)||tried.includes(w));
  return w;
}
function buildProxy(w,p){
  return `${CFG.proxyDomains.prefix}${w}${CFG.proxyDomains.suffix}${p}`;
}
function getLogoUrl(url){
  if(!url) return CFG.logoUrlMapping.replaceBrokenLogo;
  const path = url.replace(CFG.logoUrlMapping.source,'');
  return buildProxy(
    currentWorker,
    `/https://cfcdn.xdapiym5297.com/zqwin007/Image/team/images/${path}`
  );
}
function retryWorker(img, original, tried=[]){
  tried.push(currentWorker);
  if(tried.length>=CFG.proxyDomains.maxRange){
    img.src=CFG.logoUrlMapping.replaceBrokenLogo;return;
  }
  currentWorker=getRandomWorker(tried);
  img.onerror=()=>retryWorker(img,original,tried);
  img.src=getLogoUrl(original);
}

/* ========== UTIL ========== */
const qs=n=>new URLSearchParams(location.search).get(n);
const matchStatus=m=>m.state===1?'LIVE':m.state===2?'SELESAI':'AKAN DATANG';
const matchTime=ts=>new Date(ts).toLocaleString('id-ID',{
  timeZone:CFG.displaySettings.timezone,
  day:'numeric',month:'long',hour:'2-digit',minute:'2-digit'
});

/* ========== LOAD MATCHES ========== */
async function loadMatches(){
  const box=document.getElementById('matches');
  const title=document.getElementById('league-title');
  const searchBox=document.getElementById('searchBox');

  box.innerHTML=`<div class="loading">${CFG.branding.loadingMessage}</div>`;

  try{
    const r=await fetch(CFG.apiUrls.matchSchedule);
    let list=(await r.json()).matchList||[];

    const leagueId=qs('id');
    const typeParam=qs('type');
    const goParam=qs('go');

    if(leagueId){
      list=list.filter(x=>x.leagueId==leagueId);
      title.textContent=list[0]?.leagueEn||'';
    }else{
      title.textContent='';
      searchBox.style.display='block';
    }

    if(typeParam && !isNaN(typeParam)){
      list=list.filter(m=>m.matchType==Number(typeParam));
    }

    const typeCounter = {}; // ðŸ”¥ COUNTER PER matchType

    function render(arr){
      box.innerHTML='';
      if(!arr.length){
        box.innerHTML='<div class="no-matches">Tidak ada pertandingan</div>';return;
      }

      arr.forEach(m=>{
        typeCounter[m.matchType] = (typeCounter[m.matchType] || 0) + 1;
        const idx = typeCounter[m.matchType];

        let stream;
        if(leagueId && goParam){
          stream = `${goParam}${idx}`;
        }else if(goParam){
          stream = goParam;
        }else if(typeParam && isNaN(typeParam)){
          stream = typeParam;
        }else{
          if(m.matchType === 2){
            stream = `nba${idx}`;
          }else if(m.matchType === 1){
            stream = `s808${idx}`;
          }else{
            stream = `${idx}`; // fallback
          }
        }

        const c=document.createElement('div');
        c.className='match-card';
        c.innerHTML=`
          <div class="match-status ${m.state===1?'live':''}">${matchStatus(m)}</div>
          <div class="match-time">${matchTime(m.matchTime_t)}</div>

          <div class="team-info">
            <div class="team">
              <img src="${getLogoUrl(m.homeLogoUrl)}"
                   onerror="retryWorker(this,'${m.homeLogoUrl}')">
              <div>${m.homeName}</div>
            </div>

            <div class="vs">VS</div>

            <div class="team">
              <img src="${getLogoUrl(m.awayLogoUrl)}"
                   onerror="retryWorker(this,'${m.awayLogoUrl}')">
              <div>${m.awayName}</div>
            </div>
          </div>

          ${m.state!==0?`<div class="score">${m.homeScore} - ${m.awayScore}</div>`:''}

          <div class="stream-links">
            <a class="stream-link" href="go:${stream}">WATCH NOW ðŸ“º</a>
          </div>
        `;
        box.appendChild(c);
      });
    }

    render(list);

  }catch{
    box.innerHTML=`<div class="error">${CFG.branding.errorMessage}</div>`;
  }
}

/* ========== INIT ========== */
(async()=>{
  await loadConfig();
  currentWorker=getRandomWorker();
  document.title=CFG.branding.siteTitle;
  document.getElementById('footer').textContent=CFG.branding.footerText;
  loadMatches();
})();
</script>

</body>
</html>
